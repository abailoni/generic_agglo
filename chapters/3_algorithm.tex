% !TEX root = ../agglo_clust_review.tex

\section{Generalized framework for agglomerative clustering of signed graphs} \label{sec:general_framework}
% In this section, we first define notation and then introduce one of our main contributions: a signed graph partitioning algorithm (Sec. \ref{sec:algorithm}) that can be seen as a generalization of several existing and new clustering algorithms (Sec. \ref{sec:alg_update_rules}).

\subsection{Notation} \label{sec:notation}

\textbf{Graph formalism} -- We consider an undirected simple edge-weighted graph $\mathcal{G}(V,E,w^+, w^-)$ with both attractive and repulsive edge attributes.
% In computer vision applications, the nodes can represent either pixels, superpixels or voxels.  
The weight function $w^+: E \rightarrow \mathbb{R}^+$ associates to every edge a positive scalar attribute $w_e^+\in \mathbb{R}^+$ representing a merge affinity or a similarity measure.
% the higher this number, the higher the inclination of the two incident vertices to be assigned to the same cluster\footnote{Note that other formalisms for positively weighted graphs associate distances to the edges, thus, the \emph{lower} the edge weight, the higher the attraction between the two linked nodes, contrary to our definition of $w^+$.}. 
On the other hand, $w^-: E \rightarrow \mathbb{R}^+$ associates to each edge a split tendency $w_e^- \in \mathbb{R}^+$: \OPTIONAL{the higher this number, the higher the inclination of the two incident vertices to be assigned to different clusters}.
% the higher this weight, the more the incident vertices would like to be in different clusters. 
Graphs of the type $\mathcal{G}(V,E,w^+, w^-)$ are often defined as \emph{signed graphs} $\mathcal{G}(V,E,\cost)$, featuring positive and negative edge weights $\cost_e\in \mathbb{R}$. Following the theoretical considerations in \cite{lange2018partial}, we define these signed weights as ${\cost_e = w_e^+ - w_e^-}$. 
% Some approaches directly compute $\cost_e$, whereas others compute $w_e^+$ and $w_e^-$ separately.
% In this formalism, graphs with purely attractive interactions are a special case of $\mathcal{G}(V,E,\cost)$ with $\cost_e \geq 0, \, \forall e \in E$. 

\textbf{Multicut objective} -- We call the set $\Pi$ a \emph{clustering} or \emph{partitioning} with $K$ clusters if $V = \cup_{S\in\Pi} S $, $\,S \cap S' = \emptyset$ for different clusters $S, S'\in \Pi$ and every cluster $S \in \Pi$ induces a connected subgraph of $\mathcal{G}$. 
For any clustering $\Pi$ of $\mathcal{G}$, we define as $E^0_\Pi= \{ e_{uv} \in E \,|\, \exists S \in \Pi : u,v \in S \}$ the set of edges linking nodes in the same cluster, and as $E_\Pi^1= E \setminus E^0_\Pi$ the set of edges whose linked nodes belong to distinct clusters.
% \begin{equation}
% E_\Pi^0 \equiv \{ e_{uv} \in E \,|\, \exists S \in \Pi : u \in S \, \text{and} \, v \in S \}, \qquad E^1_\Pi \equiv E \setminus E^0_\Pi.
% \end{equation}
% \begin{align}
% E_\Pi^0 &= \{ e_{uv} \in E \,|\, \exists S \in \Pi : u \in S \, \text{and} \, v \in S \}, \\
% E^1_\Pi &= E \setminus E^0_\Pi.
% \end{align}
The set of edges $E_\Pi^1$ is known as the \emph{multicut} of $\mathcal{G}$ associated to clustering $\Pi$. The instance of the NP-hard \emph{minimum cost multicut problem} w.r.t. $\mathcal{G}(V,E,w_e)$ is the task of finding a clustering that optimally balance the attraction and repulsion in the graph and is given by the following binary integer program:
\begin{equation}
% \min_\Pi \texttt{MC}(\Pi) \equiv
 \min_\Pi \sum_{e\in E} \cost_e x_e^\Pi,  \qquad \text{where} \quad x^\Pi_e = 
 \begin{cases} 
 1 & \text{if } e\in E^1_\Pi \\
 0 & \text{otherwise}.
 \end{cases}
\end{equation}
% In the next chapters we will use this objective as a way to measure how balanced is a clustering found by the tested agglomerative clustering algorithms.


\textbf{Weight-shift hierarchical algorithms} -- Given an algorithm that outputs a clustering $\Pi$ for a signed graph $\mathcal{G}(V,E,w_e)$, we call the algorithm \emph{weight-shift hierarchical} if, by adding a constant $\alpha \in \mathbb{R}$ to all edge weights $w_e$, the algorithm outputs a clustering $\Pi'$ which is a coarsening of $\Pi$ when $\alpha>0$ and a refinement of $\Pi$ when $\alpha<0$\footnote{A clustering $\Pi'$ is a coarsening of $\Pi$ when every $S' \in \Pi'$ is the union of one or more clusters in $\Pi$. Similarly, $\Pi'$ is a refinement of $\Pi$ when every $S \in \Pi$ is given by the union of one or more clusters in $\Pi'$}.

\textbf{Linkage criteria and hierarchical trees} -- 
% We also denote as $S_u$ the cluster associated with node $u$ \TODO{Needed?}.
% We call two clusters $S,S'$ \emph{adjacent} if there exists at least one edge ${e_{ts}\in E}$ connecting a node $t\in S_u$ to a node $s\in S_v$. 
Let the interaction $\interact(S,S')$ between two clusters $S,S'$ be defined as a function $\interact{}:2^{V} \times 2^{V} \rightarrow \mathbb{R}$, named \emph{linkage criterion}, depending on the weights of \emph{all} edges connecting clusters $S$ and $S'$, i.e. ${(S \times S') \cap E}$. 
The linkage criteria tested in this article are listed and defined in Table \ref{tab:linkage-criteria}.
In hierarchical clustering (HC) literature,  a \emph{dendrogram} $T$ is a rooted binary tree\footnote{In general, one could look at trees that are not binary. However, the algorithms discussed in this paper always generate binary hierarchical trees, so nothing would be gained by this generalization.} representing the merging order of an agglomerative algorithm, such that the leaves of the tree are in one-to-one correspondence with $V$. 
Let $T_{\mathrm{R}},T_{\mathrm{L}}\subset T$ denote the subtrees rooted at the two children of the root node in $T$.
For any two leaves $u,v \in V$, let $T[u \vee v]$ be the subtree rooted at the least common ancestor $u \vee v\in T$ of nodes $u$ and $v$ (furthest from the root), and let \texttt{leaves}$(T[u \vee v])\subseteq V$ be the set of leaves of this subtree. 
% \TODO{Here we talk about the algorithm already, so we could move it to next section and the flow could be better. But we need a tree in the alg. So we better do this later}
% Algorithm \ref{main_alg} returns a binary tree denoted by $T^*$.
Given an agglomerative algorithm with merging tree $T$, let $h_T:T \rightarrow \mathbb{N}$ denote the \emph{dendrogram-height} of each $(u\vee v)\in T$, which is defined as the iteration number at which nodes $u,v\in V$ were merged (\TODO{Fig.~1}). We also define the interaction $\treeHeight(u,v)$ as the interaction $\interact{}(S,S')$ between the two clusters $S,S'$ that were merged at iteration $h_T(u\vee v)$: 
% Then, given a binary tree $T$ and a linkage criterion $\interact$, we can associate a \emph{signed similarity} function $\treeHeight$ to each pair of distinct original nodes $u\neq v$, with $u, v \in V$:
\begin{equation}\label{eq:def_dendr_interact}
\treeHeight(u,v) \equiv \interact{} \big( \text{\texttt{leaves}}(T_{\mathrm{R}}[u \vee v]), \text{\texttt{leaves}}(T_{\mathrm{L}}[u \vee v]) \big)
\end{equation}
% \OPTIONAL{In other words, $h_T(u,v)$ and $\treeHeight(u,v)$ represent the \emph{dendrogram-height} and \emph{signed-interaction} associated to each $u \vee v$ node in the tree $T$ (see toy example in \TODO{Fig.~1}).}




% \begin{algorithm}[t]
%   \caption{\algname{}: generalized algorithm for signed graph partitioning}
%    \hspace*{\algorithmicindent} \textbf{Input:} Graph $\mathcal{G}(V,E,w^+,w^-)$; linkage criterion $\interact{}$; boolean {\color{blue}\texttt{addCannotLinkConstraints}}  \\
%   \hspace*{\algorithmicindent} \textbf{Output:} Final clustering $\Pi$\\
%   \hspace*{\algorithmicindent} 
%   \begin{algorithmic}[1]
%       \State Initialize clustering $\Pi=\{\{v_1\}, \ldots, \{v_{|V|}\}\}$ with each node in its own cluster
%       \State Initial interactions between nodes given by $\cost_e = w^+_e - w^-_e$
%       \Repeat
%         \State Select pair of clusters $S_u,S_v\in\Pi$ with highest absolute interaction $|\interact{}(S_u,S_v)|$
%         \If{\big[{\color{ForestGreen}\textbf{$\interact{}(S_u,S_v) > 0$}}\big] \textbf{and} \big[$S_u,S_v$ are \textbf{not} constrained\big]}
%           \State Merge cluster $S_u$ with $S_v$: update interactions and cannot-link constraints with all their neighbors
%         \ElsIf{\big[{\color{red}\textbf{$\interact{}(S_u,S_v) \leq 0$}}\big] \textbf{and} {\color{blue}\texttt{addCannotLinkConstraints}}}
%           \State Add CannotLink Constraint between clusters $S_u$ and $S_v$
%         \EndIf
%       \Until{\big[all interactions between clusters are repulsive\big] \textbf{or} \big[all adjacent clusters have cannot-link constraints\big]}
%       \State
%       \Return $\Pi$
%   \end{algorithmic}
%   \label{main_alg}
% \end{algorithm}



\subsection{\algname{}: generalized agglomerative algorithm for signed graph partitioning} \label{sec:algorithm} 

Our main contribution is a generalized agglomerative algorithm for signed graph partitioning (GASP) that generalizes hierarchical clustering (HC) to signed graphs. 
The framework, defined in the following, encompasses several known and new agglomerative algorithms on display in Table \ref{tab:linkage-criteria}, which are differentiated by the linkage criterion employed, similarly to HC.

\paragraph*{GASP Algorithm} -- In Algorithm \ref{main_alg}, we provide simplified pseudo-code for the proposed \algname{} algorithm. \algname{} implements a bottom-up approach that starts by assigning each node to its own cluster and then iteratively merges pairs of adjacent clusters. The algorithm proceeds in three phases. 
In \emph{Phase~One}, \algname{} selects the pair of clusters with the highest absolute interaction $|\interact(S, S')|$, so that the most attractive and the most repulsive pairs are analyzed first. If the interaction is repulsive and the algorithm option \emph{addCannotLinkConstraints} is \texttt{True}, then the two clusters are constrained so that their members can never merge in subsequent steps of \emph{Phase~One}. If the interaction is attractive, then the clusters are merged, provided that they were not previously constrained. 
After each merging iteration, the interaction between the merged cluster and its neighbors is updated according to one of the linkage criteria $\interact(S, S')$ listed in Table \ref{tab:linkage-criteria}. \emph{Phase~One} terminates when all the remaining clusters are either constrained or share repulsive interactions.
In \emph{Phase~Two}, the algorithm removes all the constraints previously introduced in \emph{Phase~One} and merges the remaining clusters that share an attractive interaction, starting from those with the most attractive ones\footnote{Note that in the version of \algname{} with \emph{addCannotLinkConstraints} set to \texttt{False}, nothing happens in \emph{Phase~Two}.}. The final \algname{} clustering $\Pi^*$ is returned at the end of \emph{Phase~Two} and it will then be composed of clusters sharing only mutual repulsive interactions. 
Finally, in \emph{Phase~3}, the algorithm keeps merging all clusters until only a single one is left, so that the full sequence of merging steps is also returned in the form of a hierarchical tree $T^*$.

The algorithm was implemented using a standard HC implementation with computational complexity $\mathcal{O}(N^2 \log N)$ (see Appendix \ref{sec:detailed_impl} for more details). 
\TODO{mention fact that constraints make algorithm slower?}

% , we comment on the algorithm's computational complexity $\mathcal{O}(N^2 \log N)$ and present our implementation given by the edge contraction Algorithm \ref{detailed_alg} based on a \emph{disjoint set data structure} and a \emph{priority queue}.

\begin{algorithm}[t]
\footnotesize
  \begin{flushleft}
  \footnotesize
  \caption{\algname{}}
  % \caption{\algname{}: generalized algorithm for signed graph partitioning}
   \hspace*{\algorithmicindent} \textbf{Input:} Graph $\mathcal{G}(V,E,w^+,w^-)$; linkage criterion $\interact{}$; \\ 
   \hspace*{4.3em}boolean {\color{blue}addCannotLinkConstraints}  \\
  \hspace*{\algorithmicindent} \textbf{Output:} Final clustering $\Pi^*$, rooted binary hierarchical tree $T^*$\\
  \hspace*{\algorithmicindent} 
  \begin{algorithmic}[1]
  \footnotesize
  % \small
      \State Initial clustering: $\Pi=\{\{v_1\}, \ldots, \{v_{|V|}\}\}$
      \State Initialize hierarchical tree $T$ with leaves nodes $V=\{v_1,\ldots,v_{|V|}\}$
      \State Initialize interactions between clusters with $\cost_e = w^+_e - w^-_e$
      \State \emph{// Phase 1: Merge positive interactions (possibly using constraints)}
      \State Push absolute interactions $|w_e|$ to priority queue $PQ$
      \Repeat 
        \State Pop $S,S'\in\Pi$ from $PQ$ with highest interaction $|\interact{}(S,S')|$
        \If{\big[{\color{green}\textbf{$\interact{}(S,S') > 0$}}\big] \textbf{and} \big[$S,S'$ \textbf{not} constrained\big]}
          \State Merge clusters $S$, $S'$ and update hierarchical tree $T$
          \State Update interactions \& constraints with neighboring clusters
        \ElsIf{{\color{blue}addCannotLinkConstr} \textbf{and}  \big[{\color{red}\textbf{$\interact{}(S,S') \leq 0$}}\big]}
          \State Add CannotLink Constraint between $S$ and $S'$
        \EndIf
      \Until{\big[$PQ$ is empty\big]}
      % \State
      % \If{{\color{blue}addCannotLinkConstr}} % \Comment{Step 2: release constraints}
      \State \emph{// Phase 2: Remove constraints \& merge all positive interactions}
      \State Push signed interactions $\interact{}(S,S')$ to PQ, $\forall S, S' \in \Pi$
      \Repeat 
        \State Pop $S,S'\in\Pi$ from $PQ$ with highest interaction $\interact{}(S,S')$
        \If{\big[{\color{green}\textbf{$\interact{}(S,S') > 0$}}\big]}
          \State Merge clusters $S$, $S'$ and update hierarchical tree $T$
          \State Update interactions with neighboring clusters
        \EndIf
      \Until{\big[{\color{red}\textbf{$\interact{}(S,S') \leq 0$}}\big]} 
      \State Save the final clustering $\Pi^* \gets \Pi$ 
      \State \emph{// Phase 3: Merge negative interactions until one single cluster is left}
      \Repeat
        \State Pop $S,S'\in\Pi$ from $PQ$ with highest interaction $\interact{}(S,S')$
        \State Merge clusters $S$, $S'$ and update hierarchical tree $T$
        \State Update interactions with neighboring clusters
      \Until{\big[Only one cluster is left in $\Pi$\big]} 
      % \EndIf
      \State
      \Return $\Pi^*$, $T^*\gets T$
  \end{algorithmic}
    \label{main_alg}
  \end{flushleft}

\end{algorithm}


\paragraph{Ultrametrics defined by \algname{}} -- The connection between HC and ultrametrics\footnote{A metric space $(X,d)$ is an \emph{ultrametric} if for every $x,y,z \in X$, $d(x,y)\leq \max \{d(x,z), d(y,z)\}$.} is well known \cite{johnson1967hierarchical,milligan1979ultrametric}. Normally, ultrametrics are associated to strictly positive \emph{similarity} or \emph{dissimilarity} measures on a graph. Here, we generalize this concept to signed graphs. To do so, we first map the signed interaction $\treeHeight{}$ defined in Eq.~\ref{eq:def_dendr_interact} to positive ``distances'' $d_{T}:V \times V \rightarrow \mathbb{R}^{+}$:
\begin{align}\label{eq:UM_def}
d_{T}(u,v)\equiv &\begin{cases}
0 & \text{if}\,\, u=v\\
M-\treeHeight(u,v) & \text{if}\,\, u\neq v
\end{cases}\quad \forall u,v\in V\\
\mathrm{where}& \quad  M \equiv  \epsilon + \max_{u',v'\in V,\,u'\neq v'}\treeHeight(u',v')
\end{align}
and where $\epsilon > 0$. By definition, we have that $d_{T}(u,v)=d_{T}(v,u)$ and $d_{T}(u,u)= 0$. We then prove the following two propositions (proofs are left in Appendix):
\begin{prop}
Consider a graph $\mathcal{G}(V,E,w_e)$, a linkage criteria $\interact{}$, and an AC algorithm returning a binary rooted tree $T$ with height $h_T$. The quantity $(V, d_{T})$ defined in Eq.~\ref{eq:UM_def} is an ultrametric iff, $\forall u,v,t \in V$:
\begin{equation}
\interact{}_{T}(u,v) > \interact{}_{T}(u,t) \Leftrightarrow h_T(u \vee v) < h_T[u \vee t] 
\end{equation}
In words, $(V, d_{T})$ is an ultrametric iff the interaction $\interact{}_{T}(u, v)$ associated to the least common ancestor ${(u\vee v)\in T}$ is both lower than any other $(u\vee v)$-descendant node and higher than any other $(u\vee v)$-ancestor node in the tree $T$.
\end{prop}
\begin{prop}
Consider the binary rooted tree $T^*$ returned by the \algname{} Algorithm~\ref{main_alg}, given a choice of linkage criteria $\interact{}$ and the use of CannotLinkConstraints. Then, the quantity $(V, d_{T^*})$ defined in Eq.~\ref{eq:UM_def} is an ultrametric only for the combinations of linkage and CannotLinkConstraints marked with $(\dagger)$ in Table~\ref{tab:linkage-criteria}.
\end{prop}




\subsection{\algname{} with different linkage criteria: new and existing algorithms} \label{sec:alg_update_rules}


% \begin{prop} 
% The Mutex Watershed Algorithm (MWS) introduced by \cite{wolf2018mutex} and with empirical $\mathcal{O}(N \log N)$ complexity outputs the same clustering $\Pi^*$ returned by  the \algname{} Algorithm \ref{main_alg} with the use of cannot-link constraints and an Absolute Maximum update rule:
% \begin{equation}\label{eq:def_abs_max}
% f_{\mathrm{Abs.Max.}}(\tilde{\cost}_1,\tilde{\cost}_2) = \begin{cases} 
%             \tilde{\cost}_1 & \text{if}\,\, |\tilde{\cost}_1|>|\tilde{\cost}_2|\\
%             \tilde{\cost}_2 & \text{otherwise}
%              \end{cases} 
% \end{equation}
% \end{prop}
\begin{prop} 
The \algname{} Algorithm \ref{main_alg} with Absolute Maximum linkage (see def. in Table \ref{tab:linkage-criteria}) returns the same final clustering $\Pi^*_{\mathrm{AbsMax}}$ whether cannot-link constraints are introduced or not. In particular, $\Pi^*_{\mathrm{AbsMax}}$ is equal to the clustering returned by the Mutex Watershed Algorithm (MWS) introduced by \cite{wolf2018mutex}, which has empirical complexity $\mathcal{O}(N \log N)$. 
\end{prop}



\begin{itemize}
\item Table \ref{tab:linkage-criteria} lists new and existing algorithms. Better: we test the five linkage criteria (columns of Table~\ref{tab:linkage-criteria}). Many more have been applied to unsigned graphs (CITS), but those five linkages represent the most common options.  
\item GASP with Average, Single, and Complete linkage criteria is equivalent to HC when a graph with only positive edges is considered
\item These three criteria have been throughly studied on (positive) similarity graphs
\item As it was already observed in CITE, we have the following observation:
\item GASP with Average, Single, and Complete linkage criteria 

\item It can be shown that the correlation clustering or multicut problem is not \emph{intrinsically-hierarchical}. Similarly, only few of the algorithms presented in this paper are \emph{intrinsically-hierarchical}
% \item Only few of the Given a linkage $\interact{}$, we say that Algorithm \ref{main_alg} is invariant to a $\alpha$ weight-shift, if by changing all edge weights of the graphs by a constant $w_e+\alpha$ the structure of the hierarchical tree  does not change and defines the same function $d_T$.
% \item \TODO{Why do we care?} MC does not return nested/hierarchical solutions when shifting weights. Which of these algorithms behave the same, or, somehow are more related to correlation clustering? So, actually, we care more about the shifted-solutions being nested, and not really about the fact that the hierarchy tree built by the algorithm stays the same. Is this somehow equivalent...?
\end{itemize}


\TODO{Specify greediness wrt multicut energy, ultrametric properties, and shift-invariance properties}  We review them in the following paragraphs.

In the special case of an unsigned graph with only positive interactions, i.e. $w_e^-=0$ and $\cost_e \geq 0$ $\forall e\in E$, 
 the algorithm performs a standard agglomerative hierarchical clustering by returning only a single cluster and a hierarchy of clusters defined by the order in which the clusters are merged (see Table \ref{tab:linkage-criteria}, unsigned graphs).

Given a graph with both attractive and repulsive cues, an edge contraction algorithm with a sum update rule was pioneered in \cite{levinkov2017comparative,keuper2015efficient} (Table \ref{tab:linkage-criteria}, \emph{Sum} linkage). The authors present both a version with cannot-link constraints and one without, and then compare them with other greedy local-search algorithms approximating the multicut optimization problem.
The Mutex Watershed \cite{wolf2018mutex} is another signed graph partitioning algorithm that introduces dynamical cannot-link constraints. In Proposition \ref{prop:equiv_MWS} (see Appendix \ref{sec:appendix_abs_max}) we prove that, surprisingly, it can also be seen as an efficient implementation of \algname{} with \emph{Absolute maximum} linkage (def. in Table \ref{tab:linkage-criteria}). Moreover, in Proposition \ref{prop:abs_max_cannot_link_property} we also prove that \algname{} with \emph{Abs Max} linkage returns the same clustering with or without enforcing cannot-link constraints.
On the other hand, to our knowledge, \emph{Average}, \emph{Max} or \emph{Min} linkage criteria have never been used for signed graph agglomerative algorithms or been combined with cannot-link constraints.

Apart from the linkage criteria defined in Table \ref{tab:linkage-criteria}, additional ones were proposed in the literature:
\cite{nunez2013machine} for example uses a learned approach where a random forest classifier updates the cluster interactions depending on predefined edge and node features; other approaches introduce a weight regularization depending on the size of the clusters \cite{felzenszwalb2004efficient,kardoostsolving}, whereas 
\cite{funke2018large} uses a \emph{quantile} linkage criterion by populating a histogram for each inter-cluster interaction. In our experiments, we decided to focus on the linkage criteria listed in Table \ref{tab:linkage-criteria}, since they represent the most common options.

% \begin{figure}[t]
% \centering
%         \begin{subfigure}[t]{0.46 \textwidth}
%         \centering
%         \includegraphics[width=\textwidth]{figs/example_no_constr.pdf}
%         \caption{No constraints}\label{subfig:no_constraints}
%     \end{subfigure} \hfill \vspace{8pt}
%     \begin{subfigure}[t]{0.46 \textwidth}
%         \centering
%         \includegraphics[width=\textwidth]{figs/example_with_constr.pdf}
%         \caption{With cannot-link constraints}\label{subfig:with_constraints}
%     \end{subfigure}
% \caption{Some iterations of the generalized algorithm (using \emph{Sum} linkage criteria) with and without adding cannot-link constraints. The graph has both attractive (green) and repulsive (red) edges and cannot-link constraints are shown with triple violet bars on the edges. The edge selected at each iteration is highlighted in yellow. We note that when constraints are enforced, the final clustering is given by two clusters instead of only one.}
% \label{fig:algorithm_with_without_CLC}
% \end{figure}


% \begin{table*}[t]
%     % \centering
%     \scriptsize
%     \begin{subtable}[t!]{\textwidth}\centering
%         \begin{tabular}{R{5em}  l | M{10em} | M{8em}  M{8em}}
%             \multicolumn{2}{c|}{\multirow{2}{*}[-0.5em]{\thead{\textbf{\algname{} linkage criteria}\\ $\,\,\interact(S_u ,S_v)$}}}  & \multirow{2}{*}[-0.5em]{\thead{\textbf{Unsigned} \\\textbf{Graphs}}} & \multicolumn{2}{c}{\thead{\textbf{Signed Graphs}}}  \\        
%             \multicolumn{2}{c|}{} &  &  \multicolumn{1}{c}{\thead{No \\Constraints}} & \thead{With\\ Constraints} \\        
      
%             \midrule
%              Sum: & $\displaystyle \sum_{e\in E_{uv}} \cost_e$ & \thead{Sum Linkage\\Hier. Aggl. Clust.} & \thead{GAEC \cite{keuper2015efficient}} & \thead{Greedy\\Fixation \cite{levinkov2017comparative}} \\ 
            
%              \makecell[r]{Abs. Max:} & 
%             $\displaystyle \cost_e$ with $\displaystyle e = \argmax_{t\in E_{uv}} |\cost_t|$
%                & \thead{Single Linkage\\Hier. Aggl. Clust.} & \thead{Mutex\\Watershed \cite{wolf2018mutex}} & \thead{Mutex\\Watershed \cite{wolf2018mutex}} \\
%              \makecell[r]{Average:} & $\displaystyle \sum_{e\in E_{uv}} \cost_e \bigg/ \big|E_{uv}\big|  $ & \thead{ Average Linkage\\ Hier. Aggl. Clust.} & \thead{\textbf{NEW}} & \thead{\textbf{NEW}}\\ 

%             Max: & $\displaystyle \max_{e\in E_{uv}} \cost_e$ & \thead{Single Linkage\\Hier. Aggl. Clust.} & \thead{\textbf{NEW}} & \thead{\textbf{NEW}}\\ 

%             Min:& $\displaystyle \min_{e\in E_{uv}} \cost_e$ & \thead{Complete Linkage\\ Hier. Aggl. Clust.}  & \thead{\textbf{NEW}} & \thead{\textbf{NEW}}
%         \end{tabular}
%     \end{subtable} 
%     \vspace{1em}
%     \caption{Existing and new clustering algorithms that can be reformulated as special cases of the proposed generalized algorithm for signed graph partitioning, \algname{}, given a linkage criterion, a type of graph (signed or unsigned) and the optional use of cannot-link constraints. The set $E_{uv}$ is defined as the set of all edges connecting cluster $S_u$ to cluster $S_v$, i.e. $E_{uv}=(S_u \times S_{v \neq u}) \cap E$.}
%     \label{tab:linkage-criteria}
% \end{table*}

\begin{table*}[t]
    \centering
    \footnotesize
    \begin{subtable}[t!]{\textwidth}\centering
        \begin{tabular}{l |c  c  c  c  c}
        % \multicolumn{1}{c}{}
        % \multirow{2}{*}[-0.5em]{\thead{\textbf{\algname{} linkage criteria} \\ $\,\,\interact(S_u ,S_v)$}}  
        & \thead{Sum\\Linkage} & \thead{Absolute Maximum\\Linkage} & \thead{Average\\Linkage} & \thead{Single\\Linkage} & \thead{Complete\\Linkage} \\
 % \multicolumn{1}{c}{} 
 & $\displaystyle \sum_{e\in E_{uv}} \cost_e$  & $\displaystyle \cost_e$ with $\displaystyle e = \argmax_{t\in E_{uv}} |\cost_t|$ & $\displaystyle \sum_{e\in E_{uv}} \cost_e \bigg/ \big|E_{uv}\big| $ &  $\displaystyle \max_{e\in E_{uv}} \cost_e$ & $\displaystyle \min_{e\in E_{uv}} \cost_e$ \\ \midrule
 % \cmidrule{2-6}

            \thead[r]{GASP on positive-weighted graphs} & \thead{-} &\thead{\emph{\textbf{HC-Single}}} &\thead{\emph{\textbf{HC-Avg}}} &\thead{\emph{\textbf{HC-Single}}} &\thead{\emph{\textbf{HC-Complete}}} \\
            \thead[r]{GASP on signed graphs} & \thead{GAEC \cite{keuper2015efficient}} & \thead{\emph{Mutex Watershed} \cite{wolf2018mutex}}& \thead{\emph{\textbf{HC-Avg}}} &\thead{\emph{\textbf{HC-Single}}} &\thead{\emph{\textbf{HC-Complete}}} \\
            \thead[r]{GASP on signed graphs + constraints} & \thead{\colorbox{yellow}{HCC-Sum}} % \thead{Greedy Fixation \cite{levinkov2017comparative}} 
            & \thead{\emph{Mutex Watershed} \cite{wolf2018mutex}}& \thead{\colorbox{yellow}{HCC-Avg}} &  \thead{\colorbox{yellow}{HCC-Single}} &  \thead{\colorbox{yellow}{HCC-Complete}} \\
            % \multicolumn{2}{c|}{\multirow{2}{*}[-0.5em]{\thead{\textbf{\algname{} linkage criteria} $\,\,\interact(S_u ,S_v)$}}}  & \multirow{2}{*}[-0.5em]{\thead{\textbf{Unsigned Graphs}}} & \multicolumn{2}{c}{\thead{\textbf{Signed Graphs}}}  \\        
            % \multicolumn{2}{c|}{} &  &  \multicolumn{1}{c}{\thead{No Constraints}} & \thead{With Constraints} \\ \midrule
             

            %  Sum: & $\displaystyle \sum_{e\in E_{uv}} \cost_e$ & \thead{Sum Linkage\\Hier. Aggl. Clust.} & \thead{GAEC \cite{keuper2015efficient}} & \thead{Greedy\\Fixation \cite{levinkov2017comparative}} \\ 
            
             


            %  \makecell[r]{Abs. Max:} & 
            % $\displaystyle \cost_e$ with $\displaystyle e = \argmax_{t\in E_{uv}} |\cost_t|$
            %    & \thead{Single Linkage\\Hier. Aggl. Clust.} & \thead{Mutex\\Watershed \cite{wolf2018mutex}} & \thead{Mutex\\Watershed \cite{wolf2018mutex}} \\
             


            %  \makecell[r]{Average:} & $\displaystyle \sum_{e\in E_{uv}} \cost_e \bigg/ \big|E_{uv}\big|  $ & \thead{ Average Linkage\\ Hier. Aggl. Clust.} & \thead{\textbf{NEW}} & \thead{\textbf{NEW}}\\ 

            % Max: & $\displaystyle \max_{e\in E_{uv}} \cost_e$ & \thead{Single Linkage\\Hier. Aggl. Clust.} & \thead{\textbf{NEW}} & \thead{\textbf{NEW}}\\ 

            % Min:& $\displaystyle \min_{e\in E_{uv}} \cost_e$ & \thead{Complete Linkage\\ Hier. Aggl. Clust.}  & \thead{\textbf{NEW}} & \thead{\textbf{NEW}}



            
        \end{tabular}
    \end{subtable} 
    \caption{Existing and new (highlighted in yellow) clustering algorithms that can be reformulated as special cases of the proposed generalized agglomerative algorithm for signed graph partitioning, \algname{}, given a linkage criterion, a type of graph (signed or unsigned) and the optional use of cannot-link constraints. Given two clusters $S_i$ and $S_j$, the set $E_{ij}$ is defined as the set of all edges connecting the two cluster, i.e. $E_{ij}=(S_i \times S_{j}) \cap E$. \TODO{Algorithm in italic define an ultrametric; algorithms in bold are weight-shift hierarchical; new ones are highlighted in yellow} } 
    \label{tab:linkage-criteria}
\end{table*}

\begin{figure*}
\centering
\includegraphics[width=\textwidth]{./figs/comparison_new.pdf} % left bottom right top
\caption{Failure cases of \algname{} with different linkage criteria highlighted on some difficult parts of the CREMI Challenge data. Only the \emph{wrongly} segmented regions are highlighted in different warm colors. Note that the data is 3D, hence the same color could be assigned to parts of segments that appear disconnected in 2D.  Red arrows point to wrongly split regions. Yellow arrows point out merge errors. The \emph{Average} linkage without cannot-link constraints returned the best segmentation.
\label{fig:cremi_comparison}}
\end{figure*}



\begin{table*}[t]
    \centering
    % \scriptsize
    \tiny
    \begin{subtable}[t!]{\textwidth}\centering
        \begin{tabular}{l  c  c  c  c  c c c c c c c c c}
        \toprule
        Dataset & Graph-Type & $\#I$ & $|V|$ & $\bar{\text{deg}}(v)$ & GT & GAEC & MWS & HC-AvgL & HC-SingleL & HC-CompleteL & Constr-SumL & Constr-AvgL & Constr-SingleL \\ \midrule
        \emph{Image Seg.} & \emph{rag} & 100 & 156-3764 &   & \HollowBox\\
        \emph{Knott-3D (150-300-450)} & \emph{rag-3D} & 24 & 572-17k &  & \HollowBox\\
        % \emph{Knott-3D-300} & \emph{rag-3D} & 8& & & \HollowBox\\
        % \emph{Knott-3D-450}& \emph{rag-3D} & 8 & & & \HollowBox\\  
        \emph{CREMI-OurUNet} & \emph{rag-3D} & 3&  & & \CrossedBox\\ 
        \emph{Fruit-Fly Level 1-4} & \emph{rag-3D} & 4& 5m-11m &  & \HollowBox\\
        \emph{Fruit-Fly Level Global} & \emph{rag-3D} & 1& 90m &  & \HollowBox\\ \midrule
                \emph{CREMI-pixGrid-OurUNet} & \emph{gridGraph} & 12& $\sim$30m & 4 & \CrossedBox\\
        % \emph{(CREMI-pixGrid-LSIMasksUNet)} & \emph{gridGraph} & 1 & & 4 & \CrossedBox\\
        \emph{(CityScapesValidation-pixGrid)} & \emph{gridGraph} &  &  & & \CrossedBox\\\midrule
        % \emph{CREMI-test....}\\\midrule
        \emph{Stochastic Block Model (synthetic)} & \emph{non-planar} &-&- & - & \CrossedBox \\
        \emph{Mod. Clustering} & \emph{complete} & 6& 34-115 & 33-114 & \HollowBox\\ 
        \emph{(epinions and slashdot?)} & \emph{dense?} &  & & & \HollowBox\\ 
        
        


            
        \end{tabular}
    \end{subtable} 
    \caption{List of used datasets and MC objectives achieved by different algorithms} 
    \label{tab:datasets_and_energies}
\end{table*}


% \begin{table}[t]
%     \centering
%     % \scriptsize
%     \tiny
%     \begin{subtable}[t!]{0.5\textwidth}\centering
%         \begin{tabular}{l  c  c  c  c  c}
%         \toprule
%         Dataset & HC-Avg & GAEC & MWS & Constr-Avg & Constr-Sum \\ \midrule
%         \emph{Image Seg.} \\
%         \emph{Knott-3D-150} \\
%         \emph{Knott-3D-300} \\
%         \emph{Knott-3D-450} \\  
%         \emph{Mod. Clustering} \\
%         \emph{Fruit-Fly Level 1-4} \\
%         \emph{Fruit-Fly Level Global} \\
%         \emph{(Epinions?)} \\
        


            
%         \end{tabular}
%     \end{subtable} 
%     \caption{} 
%     \label{tab:all_results}
% \end{table}
